version: 2

jobs:
  build:
    working_directory: ~/project
    docker:
      - image: ubuntu:19.04
    steps:
      - checkout

      - run:
          name: Install native dependencies
          command: |
            apt update
            # stack dependencies
            apt install -y g++ gcc libc6-dev libffi-dev libgmp-dev make xz-utils zlib1g-dev git gnupg netbase wget

            # install stack
            (cd /tmp && wget https://get.haskellstack.org/stable/linux-x86_64.tar.gz && tar xzf linux-x86_64.tar.gz && cp stack-*-linux-*/stack /usr/bin/stack)

            # komposition dependencies
            apt install -y \
                ffmpeg \
                sox \
                libgmp-dev \
                libavutil-dev \
                libavformat-dev \
                libavcodec-dev \
                libswscale-dev \
                libavdevice-dev \
                libgirepository1.0-dev \
                libgtk-3-dev \
                libpango1.0-dev \
                libgdk-pixbuf2.0-dev \
                libgstreamer1.0-dev \
                gstreamer1.0-libav \
                gstreamer1.0-gtk3 \
                gstreamer1.0-plugins-base \
                gstreamer1.0-plugins-good \
                gstreamer1.0-plugins-bad
      - run:
          name: Query resolver & ghc version
          command: |
            ./ci/resolver > resolver.version
            ./ci/ghc-version $(cat resolver.version) >  ghc.version

      - restore_cache:
          keys:
                - stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--{{ checksum "komposition.cabal" }}--{{ checksum "stack.yaml" }}
                - stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--{{ checksum "komposition.cabal" }}
                - stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--resolver
                - stack--{{ arch }}--{{ checksum "ghc.version" }}--ghc

      - run: stack setup

      - save_cache:
          key:    stack--{{ arch }}--{{ checksum "ghc.version" }}--ghc
          paths:  [~/.stack, ~/project/.stack-work]

      - run:
          command: stack build --no-terminal --test --bench --only-dependencies -j1

      - save_cache:
          key:    stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--resolver
          paths:  [~/.stack, ~/project/.stack-work]

      - save_cache:
          key:    stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--{{ checksum "komposition.cabal" }}
          paths:  [~/.stack, ~/project/.stack-work]

      - run:
          command: stack build --no-terminal --test --no-run-tests --bench --no-run-benchmarks

      - save_cache:
          key:    stack--{{ arch }}--{{ checksum "ghc.version" }}--{{ checksum "resolver.version" }}--{{ checksum "komposition.cabal" }}--{{ checksum "stack.yaml" }}
          paths:  [~/.stack, ~/project/.stack-work]

      - run:
          name: Running unit tests
          command: stack test

      - deploy:
          command: |
            if [ "$CIRCLE_PROJECT_USERNAME" == "owickstrom" ]; then
              if [[ "$CIRCLE_BRANCH" == "master" ]]; then
                release
              fi
            fi

workflows:
  version: 2
  build-test:
    jobs:
      - build
      # - haddock:
      #     requires:
      #       - build
